<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.comic.mapper.ComicMapper">
    <insert id="insert" parameterType="com.comic.entity.Comic" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_comic (
            title, author_id, cover, description, category_id,
            status, is_approved, view_count, collect_count
        ) VALUES (
                     #{title}, #{authorId}, #{cover}, #{description}, #{categoryId},
                     #{status}, #{isApproved}, #{viewCount}, #{collectCount}
                 )
    </insert>

    <select id="selectById" parameterType="Long" resultType="com.comic.entity.Comic">
        SELECT
            id, title, author_id, cover, description,
            category_id, status, is_approved,
            view_count, collect_count, create_time, update_time
        FROM t_comic
        WHERE id = #{id}
    </select>

    <select id="selectByAuthorId" parameterType="Long" resultType="com.comic.entity.Comic">
        SELECT * FROM t_comic WHERE author_id = #{authorId} ORDER BY create_time DESC
    </select>

    <select id="selectByCategoryId" parameterType="Integer" resultType="com.comic.entity.Comic">
        SELECT * FROM t_comic WHERE category_id = #{categoryId} AND is_approved = 1
        ORDER BY view_count DESC
    </select>

    <select id="countByCondition" parameterType="com.comic.dto.ComicQueryDTO" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_comic
        <where>
            <if test="keyword != null and keyword != ''">
                AND (title LIKE CONCAT('%', #{keyword}, '%') OR author_id IN (SELECT id FROM t_user WHERE username LIKE CONCAT('%', #{keyword}, '%')))
            </if>
            <if test="categoryId != null">
                AND category_id = #{categoryId}
            </if>
        </where>
    </select>

    <select id="listByCondition" resultType="com.comic.vo.ComicVO">
        SELECT
        c.id,
        c.title,
        c.cover,
        c.description,  <!-- 添加description字段 -->
        c.category_id as categoryId, <!-- 添加分类ID -->
        u.nickname as authorName,  <!-- 直接查作者昵称 -->
        cat.name as categoryName,  <!-- 直接查分类名称 -->
        c.status,
        c.view_count as viewCount,
        c.collect_count as collectCount,
        c.create_time as createTime
        FROM t_comic c
        LEFT JOIN t_user u ON c.author_id = u.id  <!-- 关联用户表 -->
        LEFT JOIN t_category cat ON c.category_id = cat.id  <!-- 关联分类表 -->
        <where>
            <if test="queryDTO.keyword != null and queryDTO.keyword != ''">
                AND (c.title LIKE CONCAT('%', #{queryDTO.keyword}, '%')
                OR u.username LIKE CONCAT('%', #{queryDTO.keyword}, '%'))
            </if>
            <if test="queryDTO.categoryId != null">
                AND c.category_id = #{queryDTO.categoryId}
            </if>
            <!-- 注释掉审核限制，让所有漫画都能显示在热门榜 -->
            <!-- <if test="queryDTO.sort == 'viewCount' or queryDTO.sort == 'collectCount'">
                AND c.is_approved = 1
            </if> -->
        </where>
        <if test="queryDTO.sort != null and queryDTO.sort != ''">
            <choose>
                <when test="queryDTO.sort == 'viewCount'">
                    ORDER BY c.view_count ${queryDTO.order}
                </when>
                <when test="queryDTO.sort == 'collectCount'">
                    ORDER BY c.collect_count ${queryDTO.order}
                </when>
                <when test="queryDTO.sort == 'createTime'">
                    ORDER BY c.create_time ${queryDTO.order}
                </when>
                <otherwise>
                    ORDER BY c.create_time DESC
                </otherwise>
            </choose>
        </if>
        <if test="queryDTO.sort == null or queryDTO.sort == ''">
            ORDER BY c.create_time DESC
        </if>
        LIMIT #{offset}, #{size}
    </select>


</mapper>